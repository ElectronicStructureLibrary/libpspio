#!/bin/sh

my_name=`basename "${0}"`
my_fmt=`echo "${my_name}" | cut -d_ -f4-`
psp_root="@srcdir@/../psp_references"

if test "${my_fmt}" = ""; then
  echo "${my_name}: must be run by the test suite of Pspio" >&2
  exit 101
fi

case "${my_fmt}" in
  abinit1)
    psp_dir="abinit1"
    ;;
  abinit2)
    psp_dir="abinit2"
    ;;
  abinit3)
    psp_dir="abinit3"
    ;;
  abinit4)
    psp_dir="abinit4"
    ;;
  abinit5)
    psp_dir="abinit5"
    ;;
  abinit6)
    psp_dir="abinit6"
    ;;
  abinit7)
    psp_dir="abinit7"
    ;;
  abinit8)
    psp_dir="abinit8"
    ;;
  abinit9)
    psp_dir="abinit9"
    ;;
  abinit10)
    psp_dir="abinit10"
    ;;
  abinit11)
    psp_dir="abinit11"
    ;;
  abinit17)
    psp_dir="abinit17"
    ;;
  atom)
    psp_dir="atom"
    ;;
  fhi98pp)
    psp_dir="fhi"
    ;;
  octopus_hgh)
    psp_dir="octopus_hgh"
    ;;
  siesta)
    psp_dir="siesta"
    ;;
  upf)
    psp_dir="UPF"
    ;;
  xml)
    psp_dir="xml"
    ;;
  *)
    echo "${my_name}: unknown pseudopotential format '${my_fmt}'" >&2
    exit 102
    ;;
esac

if test ! -d "${psp_root}/${psp_dir}"; then
  echo "${my_name}: missing pseudopotential directory '${psp_dir}'" >&2
  exit 103
fi

ret=0
for psp_file in ${psp_root}/${psp_dir}/*; do
  if test "`basename ${psp_file}`" != "README"; then
    echo "./test_format ${my_fmt} ${psp_file}" >&2
    ./test_format "${my_fmt}" "${psp_file}"
    ret="${?}"
    test "${ret}" = "0" || break
  fi
done

exit "${ret}"
